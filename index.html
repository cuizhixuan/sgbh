<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阶位材料升级计算器</title>
    <style>
        :root {
            --primary-color: #2a8cff;
            --primary-dark: #1a7ae6;
            --secondary-color: #32d74b;
            --danger-color: #ff453a;
            --warning-color: #ff9f0a;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #8e8e93;
            --bg-primary: #ffffff;
            --bg-secondary: #f2f2f7;
            --bg-tertiary: #e5e5ea;
            --border-color: #c7c7cc;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            padding-bottom: 80px;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        /* 顶部标题栏 */
        .header {
            background-color: var(--bg-primary);
            padding: var(--spacing-lg) var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: var(--spacing-sm);
        }

        .header .subtitle {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            text-align: center;
        }

        /* 兵种分组容器（合并后的卡片） */
        .class-group-card {
            background-color: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--card-shadow);
            margin-bottom: var(--spacing-md);
        }

        /* 兵种分组标题 */
        .class-group-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .class-group-header h2 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            flex: 1;
        }

        .class-group-header.infantry h2 { color: #2a8cff; }
        .class-group-header.cavalry h2 { color: #32d74b; }
        .class-group-header.archer h2 { color: #ff9f0a; }

        .class-group-header::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            border-radius: 2px;
        }
        .class-group-header.infantry::before { background-color: #2a8cff; }
        .class-group-header.cavalry::before { background-color: #32d74b; }
        .class-group-header.archer::before { background-color: #ff9f0a; }

        /* 角色行（合并后每个兵种下的角色行） */
        .character-row {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        .character-row:last-child { margin-bottom: 0; }

        .character-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .character-name {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 等级选择器 - 简化动画，锁死宽度，修正箭头 */
        .level-selectors {
            display: flex;
            gap: var(--spacing-md);
            width: 100%;
            overflow: hidden;
        }

        .level-selector {
            flex: 1;
            min-width: 0 !important;
            max-width: calc(50% - var(--spacing-md)/2) !important;
            width: calc(50% - var(--spacing-md)/2) !important;
            overflow: hidden;
            position: relative;
        }

        .level-selector label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        /* 修正箭头：垂直居中对齐，不再靠下 */
        .select-wrapper {
            width: 100% !important;
            height: 44px !important;
            overflow: hidden !important;
            position: relative;
        }

        .select-wrapper select {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 0 !important;
            height: 100% !important;
            padding: 0 12px !important;
            font-size: var(--font-size-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            appearance: none !important;
            -webkit-appearance: none !important;
            resize: none !important;
            white-space: nowrap;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            box-sizing: border-box !important;
        }

        /* 下拉箭头：精准垂直居中，修正靠下问题 */
        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%); /* 精准居中，解决靠下问题 */
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236e6e73' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-size: contain;
            pointer-events: none;
            z-index: 1;
        }

        .select-wrapper select:disabled {
            background-color: var(--bg-secondary);
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        /* 目标option仅保留可选项，不可选的直接不渲染 */
        .select-wrapper select option {
            width: 200px !important;
            max-width: 200px !important;
            min-width: 0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            padding: 8px 12px !important;
            font-size: var(--font-size-sm) !important;
            box-sizing: border-box !important;
            display: block !important;
        }

        /* 浏览器兼容兜底 */
        @-moz-document url-prefix() {
            .select-wrapper select {
                text-indent: 0.01px;
                text-overflow: '';
                border: 1px solid var(--border-color) !important;
            }
        }

        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            .select-wrapper select {
                border: 1px solid var(--border-color) !important;
            }
            .select-wrapper select option {
                width: 200px !important;
            }
        }

        .char-status {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--text-tertiary);
        }

        /* 材料输入区域 */
        .materials-input {
            background-color: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--card-shadow);
        }

        .materials-input h3 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .material-item {
            display: flex;
            flex-direction: column;
        }

        .material-item label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .material-item input {
            padding: 10px 12px;
            font-size: var(--font-size-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .material-item input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* 礼包设置 */
        .package-settings {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .package-settings h4 {
            font-size: var(--font-size-md);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        /* 按钮组：移除缩放动画，简化交互 */
        .button-group {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-primary);
            padding: var(--spacing-md);
            display: flex;
            gap: var(--spacing-md);
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
            z-index: 1000;
        }

        .button-group button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease; /* 仅保留背景色过渡，移除缩放 */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        #calculate-all {
            background-color: var(--secondary-color);
            color: white;
        }

        #calculate-all:active {
            background-color: #2cc142; /* 仅保留背景色变化，移除transform: scale */
        }

        /* 结果区域：移除淡入动画，简化样式 */
        .results-section {
            background-color: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            box-shadow: var(--card-shadow);
        }

        .result-summary {
            margin-bottom: var(--spacing-lg);
        }

        .result-summary h3 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .result-item {
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item h4 {
            font-size: var(--font-size-md);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .result-content {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .result-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin-left: var(--spacing-sm);
        }

        .badge-enough {
            background-color: rgba(50, 215, 75, 0.1);
            color: var(--secondary-color);
        }

        .badge-need {
            background-color: rgba(255, 69, 58, 0.1);
            color: var(--danger-color);
        }

        /* 响应式调整：锁死宽度，无额外动画 */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
            }
            .character-row {
                flex-direction: row;
                align-items: center;
            }
            .level-selector {
                max-width: calc(50% - var(--spacing-md)/2) !important;
                width: calc(50% - var(--spacing-md)/2) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部标题栏 -->
        <div class="header">
            <h1>阶位材料升级计算器</h1>
            <div class="subtitle">冰球弹弹乐 · 神兵进阶规划</div>
        </div>

        <!-- 神兵输入区域 -->
        <div class="characters-container">
            <!-- 步兵组 -->
            <div class="class-group-card">
                <div class="class-group-header infantry">
                    <h2>步兵</h2>
                </div>
                
                <!-- 步兵1 -->
                <div class="character-row">
                    <div class="character-row-header">
                        <div class="character-name">步1</div>
                    </div>
                    <div class="level-selectors">
                        <div class="level-selector">
                            <label for="current-level-1">当前等级</label>
                            <div class="select-wrapper">
                                <select id="current-level-1" class="current-level-select"></select>
                            </div>
                        </div>
                        <div class="level-selector">
                            <label for="target-level-1">目标等级</label>
                            <div class="select-wrapper">
                                <select id="target-level-1" class="target-level-select" disabled></select>
                            </div>
                        </div>
                    </div>
                    <div class="char-status" id="char-status-1">
                        <div class="status-dot"></div>
                        <span id="status-text-1">请先选择当前等级</span>
                    </div>
                </div>
                
                <!-- 步兵2 -->
                <div class="character-row">
                    <div class="character-row-header">
                        <div class="character-name">步2</div>
                    </div>
                    <div class="level-selectors">
                        <div class="level-selector">
                            <label for="current-level-2">当前等级</label>
                            <div class="select-wrapper">
                                <select id="current-level-2" class="current-level-select"></select>
                            </div>
                        </div>
                        <div class="level-selector">
                            <label for="target-level-2">目标等级</label>
                            <div class="select-wrapper">
                                <select id="target-level-2" class="target-level-select" disabled></select>
                            </div>
                        </div>
                    </div>
                    <div class="char-status" id="char-status-2">
                        <div class="status-dot"></div>
                        <span id="status-text-2">请先选择当前等级</span>
                    </div>
                </div>
            </div>
            
            <!-- 骑兵组 -->
            <div class="class-group-card">
                <div class="class-group-header cavalry">
                    <h2>骑兵</h2>
                </div>
                
                <!-- 骑兵1 -->
                <div class="character-row">
                    <div class="character-row-header">
                        <div class="character-name">骑1</div>
                    </div>
                    <div class="level-selectors">
                        <div class="level-selector">
                            <label for="current-level-3">当前等级</label>
                            <div class="select-wrapper">
                                <select id="current-level-3" class="current-level-select"></select>
                            </div>
                        </div>
                        <div class="level-selector">
                            <label for="target-level-3">目标等级</label>
                            <div class="select-wrapper">
                                <select id="target-level-3" class="target-level-select" disabled></select>
                            </div>
                        </div>
                    </div>
                    <div class="char-status" id="char-status-3">
                        <div class="status-dot"></div>
                        <span id="status-text-3">请先选择当前等级</span>
                    </div>
                </div>
                
                <!-- 骑兵2 -->
                <div class="character-row">
                    <div class="character-row-header">
                        <div class="character-name">骑2</div>
                    </div>
                    <div class="level-selectors">
                        <div class="level-selector">
                            <label for="current-level-4">当前等级</label>
                            <div class="select-wrapper">
                                <select id="current-level-4" class="current-level-select"></select>
                            </div>
                        </div>
                        <div class="level-selector">
                            <label for="target-level-4">目标等级</label>
                            <div class="select-wrapper">
                                <select id="target-level-4" class="target-level-select" disabled></select>
                            </div>
                        </div>
                    </div>
                    <div class="char-status" id="char-status-4">
                        <div class="status-dot"></div>
                        <span id="status-text-4">请先选择当前等级</span>
                    </div>
                </div>
            </div>
            
            <!-- 弓兵组 -->
            <div class="class-group-card">
                <div class="class-group-header archer">
                    <h2>弓兵</h2>
                </div>
                
                <!-- 弓兵1 -->
                <div class="character-row">
                    <div class="character-row-header">
                        <div class="character-name">弓1</div>
                    </div>
                    <div class="level-selectors">
                        <div class="level-selector">
                            <label for="current-level-5">当前等级</label>
                            <div class="select-wrapper">
                                <select id="current-level-5" class="current-level-select"></select>
                            </div>
                        </div>
                        <div class="level-selector">
                            <label for="target-level-5">目标等级</label>
                            <div class="select-wrapper">
                                <select id="target-level-5" class="target-level-select" disabled></select>
                            </div>
                        </div>
                    </div>
                    <div class="char-status" id="char-status-5">
                        <div class="status-dot"></div>
                        <span id="status-text-5">请先选择当前等级</span>
                    </div>
                </div>
                
                <!-- 弓兵2 -->
                <div class="character-row">
                    <div class="character-row-header">
                        <div class="character-name">弓2</div>
                    </div>
                    <div class="level-selectors">
                        <div class="level-selector">
                            <label for="current-level-6">当前等级</label>
                            <div class="select-wrapper">
                                <select id="current-level-6" class="current-level-select"></select>
                            </div>
                        </div>
                        <div class="level-selector">
                            <label for="target-level-6">目标等级</label>
                            <div class="select-wrapper">
                                <select id="target-level-6" class="target-level-select" disabled></select>
                            </div>
                        </div>
                    </div>
                    <div class="char-status" id="char-status-6">
                        <div class="status-dot"></div>
                        <span id="status-text-6">请先选择当前等级</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 材料输入区域 -->
        <div class="materials-input">
            <h3>全局材料设置</h3>
            <div class="materials-grid">
                <div class="material-item">
                    <label for="global-owned-zitan">已拥有紫檀木</label>
                    <input type="number" id="global-owned-zitan" min="0" value="0">
                </div>
                <div class="material-item">
                    <label for="global-owned-jingjin">已拥有精金</label>
                    <input type="number" id="global-owned-jingjin" min="0" value="0">
                </div>
                <div class="material-item">
                    <label for="global-owned-qingjin">已拥有青金石</label>
                    <input type="number" id="global-owned-qingjin" min="0" value="0">
                </div>
            </div>
            
            <div class="package-settings">
                <h4>礼包设置</h4>
                <div class="materials-grid">
                    <div class="material-item">
                        <label for="zitan-package">紫檀木礼包</label>
                        <input type="number" id="zitan-package" min="1" value="12">
                    </div>
                    <div class="material-item">
                        <label for="zitan-pkg-price">礼包价格</label>
                        <input type="number" id="zitan-pkg-price" min="1" value="11">
                    </div>
                </div>
                <div class="materials-grid">
                    <div class="material-item">
                        <label for="jingjin-package">精金礼包</label>
                        <input type="number" id="jingjin-package" min="1" value="1">
                    </div>
                    <div class="material-item">
                        <label for="jingjin-pkg-price">礼包价格</label>
                        <input type="number" id="jingjin-pkg-price" min="1" value="18">
                    </div>
                </div>
                <div class="materials-grid">
                    <div class="material-item">
                        <label for="qingjin-package">青金石礼包</label>
                        <input type="number" id="qingjin-package" min="1" value="1">
                    </div>
                    <div class="material-item">
                        <label for="qingjin-pkg-price">礼包价格</label>
                        <input type="number" id="qingjin-pkg-price" min="1" value="55">
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 16px;">
                <label for="total-activity-coin" style="display: block; font-weight: 600; margin-bottom: 8px;">可用活动币</label>
                <input type="number" id="total-activity-coin" min="0" value="0" style="width: 100%; padding: 12px; font-size: 16px;">
            </div>
        </div>

        <!-- 结果区域：移除淡入动画类 -->
        <div class="results-section" id="results-section">
            <div class="result-summary">
                <h3>计算结果</h3>
                <div id="total-result">
                    <p style="color: var(--text-secondary); text-align: center;">请点击"汇总计算"查看结果</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部按钮组 -->
    <div class="button-group">
        <button id="calculate-all">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            汇总计算
        </button>
    </div>

    <script>
        // 材料数据
        const levelMaterialData = {
            1: [1000, 50, 0], 2: [1500, 75, 0], 3: [2000, 100, 0], 4: [2500, 125, 0], 5: [3000, 150, 0],
            6: [3500, 175, 0], 7: [4000, 200, 0], 8: [4500, 225, 0], 9: [5000, 250, 0], 10: [5500, 275, 0],
            11: [6000, 300, 150], 12: [6500, 325, 160], 13: [7000, 350, 170], 14: [7500, 375, 180], 15: [8000, 400, 190],
            16: [8500, 425, 200], 17: [9000, 450, 210], 18: [9500, 475, 220], 19: [10000, 500, 230], 20: [10500, 525, 240],
            21: [11000, 550, 250], 22: [11500, 575, 260], 23: [12000, 600, 270], 24: [12500, 625, 280], 25: [13000, 650, 290],
            26: [13500, 675, 300], 27: [14000, 700, 310], 28: [14500, 725, 320], 29: [15000, 750, 330], 30: [15500, 775, 340],
            31: [16000, 800, 350], 32: [16500, 825, 360], 33: [17000, 850, 370], 34: [17500, 875, 380], 35: [18000, 900, 390],
            36: [18500, 925, 400], 37: [19000, 950, 410], 38: [19500, 975, 420], 39: [20000, 1000, 430], 40: [20500, 1025, 440],
            41: [21000, 1050, 450], 42: [21500, 1075, 460], 43: [22000, 1100, 470], 44: [22500, 1125, 480], 45: [23000, 1150, 490],
            46: [23500, 1175, 500], 47: [24000, 1200, 510], 48: [24500, 1225, 520], 49: [25000, 1250, 530], 50: [25500, 1275, 540]
        };
        
        const levelNameMap = {
            1: "绿1", 2: "绿2", 3: "绿3", 4: "绿4", 5: "绿5",
            6: "蓝1", 7: "蓝2", 8: "蓝3", 9: "蓝4", 10: "蓝5",
            11: "紫1", 12: "紫2", 13: "紫3", 14: "紫4", 15: "紫5",
            16: "紫6", 17: "紫7", 18: "紫8", 19: "紫9", 20: "紫10",
            21: "红1", 22: "红2", 23: "红3", 24: "红4", 25: "红5",
            26: "红6", 27: "红7", 28: "红8", 29: "红9", 30: "红10",
            31: "红11", 32: "红12", 33: "红13", 34: "红14", 35: "红15",
            36: "红16", 37: "红17", 38: "红18", 39: "红19", 40: "红20",
            41: "红21", 42: "红22", 43: "红23", 44: "红24", 45: "红25",
            46: "红26", 47: "红27", 48: "红28", 49: "红29", 50: "红30"
        };

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            for (let i = 1; i <= 6; i++) {
                initLevelSelectors(i);
            }

            document.getElementById('calculate-all').addEventListener('click', calculateTotal);

            // 绑定当前等级变化事件
            document.querySelectorAll('.current-level-select').forEach(select => {
                select.addEventListener('change', function() {
                    const charId = this.id.split('-')[2];
                    updateTargetLevelOptions(charId); // 重构：不展示不可选option
                    updateStatusText(charId);
                });
            });

            document.querySelectorAll('.target-level-select').forEach(select => {
                select.addEventListener('change', function() {
                    const charId = this.id.split('-')[2];
                    updateStatusText(charId);
                });
            });
        });

        // 初始化等级选择器
        function initLevelSelectors(charId) {
            const currentSelect = document.getElementById(`current-level-${charId}`);
            const targetSelect = document.getElementById(`target-level-${charId}`);
            
            // 清空现有选项
            currentSelect.innerHTML = '';
            targetSelect.innerHTML = '';
            
            // 添加空选项
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '请选择';
            currentSelect.appendChild(emptyOption.cloneNode(true));
            targetSelect.appendChild(emptyOption);
            
            // 添加等级选项
            for (let level = 1; level <= 50; level++) {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `${level}-${levelNameMap[level]}`;
                currentSelect.appendChild(option.cloneNode(true));
                targetSelect.appendChild(option);
            }
            
            // 初始状态
            currentSelect.value = '';
            targetSelect.value = '';
            targetSelect.disabled = true;
            updateStatusText(charId);
        }

        // 重构：目标等级仅展示可选选项（不可选的直接不渲染，而非隐藏）
        function updateTargetLevelOptions(charId) {
            const currentSelect = document.getElementById(`current-level-${charId}`);
            const targetSelect = document.getElementById(`target-level-${charId}`);
            const currentLevel = parseInt(currentSelect.value);
            
            // 无当前等级：禁用并重置目标选择器
            if (!currentLevel) {
                targetSelect.disabled = true;
                targetSelect.innerHTML = '';
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '请选择';
                targetSelect.appendChild(emptyOption);
                targetSelect.value = '';
                return;
            }
            
            // 有当前等级：重新生成仅包含可选选项的目标列表（≥当前等级）
            targetSelect.disabled = false;
            targetSelect.innerHTML = ''; // 清空所有旧选项
            
            // 第一步：添加空选项
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '请选择';
            targetSelect.appendChild(emptyOption);
            
            // 第二步：仅添加 ≥ 当前等级的选项（不可选的直接不生成，彻底不展示）
            for (let level = currentLevel; level <= 50; level++) {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `${level}-${levelNameMap[level]}`;
                targetSelect.appendChild(option);
            }
            
            // 默认选中当前等级（提升用户体验）
            targetSelect.value = currentLevel;
        }

        // 更新状态文本
        function updateStatusText(charId) {
            const statusText = document.getElementById(`status-text-${charId}`);
            const currentSelect = document.getElementById(`current-level-${charId}`);
            const targetSelect = document.getElementById(`target-level-${charId}`);
            const currentLevel = parseInt(currentSelect.value);
            const targetLevel = parseInt(targetSelect.value);
            const statusDot = document.getElementById(`char-status-${charId}`).querySelector('.status-dot');
            
            if (!currentLevel) {
                statusText.textContent = "请先选择当前等级";
                statusDot.style.backgroundColor = "var(--warning-color)";
            } else {
                statusText.textContent = `${levelNameMap[currentLevel]} → ${levelNameMap[targetLevel]}`;
                statusDot.style.backgroundColor = "var(--secondary-color)";
            }
        }

        // 计算总需求
        function calculateTotal() {
            // 读取全局材料拥有量
            const ownedZitan = parseInt(document.getElementById('global-owned-zitan').value) || 0;
            const ownedJingjin = parseInt(document.getElementById('global-owned-jingjin').value) || 0;
            const ownedQingjin = parseInt(document.getElementById('global-owned-qingjin').value) || 0;
            
            // 读取礼包配置
            const zitanPerPackage = parseInt(document.getElementById('zitan-package').value) || 12;
            const zitanPrice = parseInt(document.getElementById('zitan-pkg-price').value) || 11;
            const jingjinPerPackage = parseInt(document.getElementById('jingjin-package').value) || 1;
            const jingjinPrice = parseInt(document.getElementById('jingjin-pkg-price').value) || 18;
            const qingjinPerPackage = parseInt(document.getElementById('qingjin-package').value) || 1;
            const qingjinPrice = parseInt(document.getElementById('qingjin-pkg-price').value) || 55;
            
            // 读取活动币
            const totalCoin = parseInt(document.getElementById('total-activity-coin').value) || 0;

            // 计算所有神兵的总材料需求
            let totalZitanNeed = 0, totalJingjinNeed = 0, totalQingjinNeed = 0;
            let charDetails = [];

            for (let charId = 1; charId <= 6; charId++) {
                const currentLevel = parseInt(document.getElementById(`current-level-${charId}`).value);
                const targetLevel = parseInt(document.getElementById(`target-level-${charId}`).value);
                
                // 跳过未选择等级的角色
                if (!currentLevel || !targetLevel || currentLevel >= targetLevel) continue;

                // 计算单个角色的材料需求
                let charZitan = 0, charJingjin = 0, charQingjin = 0;
                for (let level = currentLevel + 1; level <= targetLevel; level++) {
                    const [zitan, jingjin, qingjin] = levelMaterialData[level] || [0, 0, 0];
                    charZitan += zitan;
                    charJingjin += jingjin;
                    charQingjin += qingjin;
                }

                // 累加总需求
                totalZitanNeed += charZitan;
                totalJingjinNeed += charJingjin;
                totalQingjinNeed += charQingjin;

                // 记录单个角色详情
                charDetails.push({
                    id: charId,
                    name: getCharName(charId),
                    currentLevel: currentLevel,
                    targetLevel: targetLevel,
                    zitan: charZitan,
                    jingjin: charJingjin,
                    qingjin: charQingjin
                });
            }

            // 计算缺口
            const zitanShortage = Math.max(0, totalZitanNeed - ownedZitan);
            const jingjinShortage = Math.max(0, totalJingjinNeed - ownedJingjin);
            const qingjinShortage = Math.max(0, totalQingjinNeed - ownedQingjin);

            // 计算需要购买的礼包数和花费
            const zitanPackages = Math.ceil(zitanShortage / zitanPerPackage);
            const zitanCost = zitanPackages * zitanPrice;
            const jingjinPackages = Math.ceil(jingjinShortage / jingjinPerPackage);
            const jingjinCost = jingjinPackages * jingjinPrice;
            const qingjinPackages = Math.ceil(qingjinShortage / qingjinPerPackage);
            const qingjinCost = qingjinPackages * qingjinPrice;

            const totalCost = zitanCost + jingjinCost + qingjinCost;
            const coinSurplus = totalCoin - totalCost;

            // 生成结果HTML
            let resultHTML = `
                <div class="result-item">
                    <h4>总材料需求</h4>
                    <div class="result-content">
                        <p>紫檀木：${formatNumber(totalZitanNeed)}（已拥有：${formatNumber(ownedZitan)}，缺口：${formatNumber(zitanShortage)}）
                            ${zitanShortage > 0 ? `<span class="result-badge badge-need">需购${zitanPackages}个礼包</span>` : `<span class="result-badge badge-enough">足够</span>`}
                        </p>
                        <p>精金：${formatNumber(totalJingjinNeed)}（已拥有：${formatNumber(ownedJingjin)}，缺口：${formatNumber(jingjinShortage)}）
                            ${jingjinShortage > 0 ? `<span class="result-badge badge-need">需购${jingjinPackages}个礼包</span>` : `<span class="result-badge badge-enough">足够</span>`}
                        </p>
                        <p>青金石：${formatNumber(totalQingjinNeed)}（已拥有：${formatNumber(ownedQingjin)}，缺口：${formatNumber(qingjinShortage)}）
                            ${qingjinShortage > 0 ? `<span class="result-badge badge-need">需购${qingjinPackages}个礼包</span>` : `<span class="result-badge badge-enough">足够</span>`}
                        </p>
                    </div>
                </div>
                <div class="result-item">
                    <h4>礼包花费</h4>
                    <div class="result-content">
                        <p>紫檀木礼包：${zitanPackages}个 × ${zitanPrice} = ${formatNumber(zitanCost)} 活动币</p>
                        <p>精金礼包：${jingjinPackages}个 × ${jingjinPrice} = ${formatNumber(jingjinCost)} 活动币</p>
                        <p>青金石礼包：${qingjinPackages}个 × ${qingjinPrice} = ${formatNumber(qingjinCost)} 活动币</p>
                        <p><strong>总计：${formatNumber(totalCost)} 活动币</strong></p>
                        <p>可用活动币：${formatNumber(totalCoin)} → 剩余：${formatNumber(coinSurplus)} ${coinSurplus < 0 ? '<span class="result-badge badge-need">不足</span>' : '<span class="result-badge badge-enough">足够</span>'}</p>
                    </div>
                </div>
            `;

            // 添加单个角色详情
            if (charDetails.length > 0) {
                resultHTML += `
                    <div class="result-item">
                        <h4>各角色材料需求</h4>
                        <div class="result-content">
                `;
                charDetails.forEach(char => {
                    resultHTML += `
                        <p><strong>${char.name}</strong>（${levelNameMap[char.currentLevel]} → ${levelNameMap[char.targetLevel]}）：
                        紫檀木${formatNumber(char.zitan)}、精金${formatNumber(char.jingjin)}、青金石${formatNumber(char.qingjin)}</p>
                    `;
                });
                resultHTML += `
                        </div>
                    </div>
                `;
            }

            // 显示结果
            document.getElementById('total-result').innerHTML = resultHTML;
        }

        // 辅助函数：获取角色名称
        function getCharName(charId) {
            const nameMap = {
                1: '步1', 2: '步2', 3: '骑1', 4: '骑2', 5: '弓1', 6: '弓2'
            };
            return nameMap[charId] || `角色${charId}`;
        }

        // 辅助函数：格式化数字（千分位）
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>
</body>
</html>
